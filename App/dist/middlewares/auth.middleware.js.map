{"version":3,"sources":["../../src/middlewares/auth.middleware.ts"],"sourcesContent":["import { verify } from 'jsonwebtoken';\nimport { AuthChecker } from 'type-graphql';\nimport { getRepository } from 'typeorm';\nimport { SECRET_KEY } from '@config';\nimport { UserEntity } from '@entities/users.entity';\nimport { HttpException } from '@exceptions/HttpException';\nimport { RequestWithUser, DataStoredInToken } from '@interfaces/auth.interface';\n\nexport const authMiddleware = async req => {\n  try {\n    const Authorization = req.cookies['Authorization'] || (req.header('Authorization') ? req.header('Authorization').split('Bearer ')[1] : null);\n    if (Authorization) {\n      const secretKey: string = SECRET_KEY;\n      const { id } = (await verify(Authorization, secretKey)) as DataStoredInToken;\n      const userRepository = getRepository(UserEntity);\n      const findUser = await userRepository.findOne(id, { select: ['id', 'email', 'password'] });\n      return findUser;\n    }\n\n    return null;\n  } catch (error) {\n    throw new HttpException(401, 'Wrong authentication token');\n  }\n};\n\nexport const authChecker: AuthChecker<RequestWithUser> = async ({ context: { user } }) => {\n  if (!user) {\n    throw new HttpException(404, 'Authentication token missing');\n  }\n\n  return true;\n};\n"],"names":["authMiddleware","authChecker","req","Authorization","cookies","header","split","secretKey","SECRET_KEY","id","verify","userRepository","getRepository","UserEntity","findUser","findOne","select","error","HttpException","context","user"],"mappings":";;;;;;;;;;;IAQaA,cAAc,MAAdA;IAiBAC,WAAW,MAAXA;;8BAzBU;yBAEO;wBACH;6BACA;+BACG;AAGvB,MAAMD,iBAAiB,OAAME,MAAO;IACzC,IAAI;QACF,MAAMC,gBAAgBD,IAAIE,OAAO,CAAC,gBAAgB,IAAKF,CAAAA,IAAIG,MAAM,CAAC,mBAAmBH,IAAIG,MAAM,CAAC,iBAAiBC,KAAK,CAAC,UAAU,CAAC,EAAE,GAAG,IAAI,AAAD;QAC1I,IAAIH,eAAe;YACjB,MAAMI,YAAoBC,kBAAU;YACpC,MAAM,EAAEC,GAAE,EAAE,GAAI,MAAMC,IAAAA,oBAAM,EAACP,eAAeI;YAC5C,MAAMI,iBAAiBC,IAAAA,sBAAa,EAACC,uBAAU;YAC/C,MAAMC,WAAW,MAAMH,eAAeI,OAAO,CAACN,IAAI;gBAAEO,QAAQ;oBAAC;oBAAM;oBAAS;iBAAW;YAAC;YACxF,OAAOF;QACT,CAAC;QAED,OAAO,IAAI;IACb,EAAE,OAAOG,OAAO;QACd,MAAM,IAAIC,4BAAa,CAAC,KAAK,8BAA8B;IAC7D;AACF;AAEO,MAAMjB,cAA4C,OAAO,EAAEkB,SAAS,EAAEC,KAAI,EAAE,CAAA,EAAE,GAAK;IACxF,IAAI,CAACA,MAAM;QACT,MAAM,IAAIF,4BAAa,CAAC,KAAK,gCAAgC;IAC/D,CAAC;IAED,OAAO,IAAI;AACb"}